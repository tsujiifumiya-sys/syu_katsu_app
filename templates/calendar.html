{% extends "base.html" %}
{% block title %}カレンダー{% endblock %}

{% block head_extra %}
<!-- FullCalendar CSS はJS内にバンドル済み（v6） -->
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>スケジュール</h1>
    <button class="btn btn-primary" onclick="openEventModal()">+ イベント追加</button>
</div>

<div class="calendar-container">
    <div id="calendar"></div>
</div>

<!-- イベント追加モーダル -->
<div class="modal-overlay" id="eventModal" style="display:none;">
    <div class="modal">
        <div class="modal-header">
            <h3 id="modalTitle">イベントを追加</h3>
            <button class="modal-close" onclick="closeModal()">✕</button>
        </div>
        <form id="eventForm" class="modal-body">
            <input type="hidden" id="eventId" value="">
            <div class="form-group">
                <label for="eventTitleInput">タイトル <span class="required">*</span></label>
                <input type="text" id="eventTitleInput" required placeholder="例: A社 1次面接">
            </div>
            <div class="form-group">
                <label for="eventType">種別</label>
                <select id="eventType">
                    {% for t in event_types %}
                    <option value="{{ t }}">{{ t }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="eventStartDate">開始日 <span class="required">*</span></label>
                    <input type="date" id="eventStartDate" required>
                </div>
                <div class="form-group">
                    <label for="eventStartTime">開始時間（任意）</label>
                    <input type="time" id="eventStartTime" placeholder="未設定OK">
                </div>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="eventEndDate">終了日（任意）</label>
                    <input type="date" id="eventEndDate">
                </div>
                <div class="form-group">
                    <label for="eventEndTime">終了時間（任意）</label>
                    <input type="time" id="eventEndTime">
                </div>
            </div>
            <div class="form-group">
                <label for="eventLocation">場所 / URL</label>
                <input type="text" id="eventLocation" placeholder="オンラインの場合はURLを入力">
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="eventSubmitBtn">追加</button>
                <button type="button" class="btn btn-danger-ghost" id="eventDeleteBtn" style="display:none;"
                    onclick="deleteEvent()">削除</button>
                <button type="button" class="btn btn-ghost" onclick="closeModal()">キャンセル</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='vendor/fullcalendar.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/fullcalendar-ja.min.js') }}"></script>
<script>
    let calendar;
    let currentEventId = null;

    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'ja',
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: { url: '/api/events', extraParams: {}, method: 'GET', credentials: 'same-origin' },
            editable: true,
            selectable: true,
            height: 'auto',
            eventClick: function (info) {
                openEventModal(info.event);
            },
            select: function (info) {
                // FullCalendar の月表示では endStr が翌日になるため、startStr を終了日にも使用
                openEventModal(null, info.startStr, info.startStr);
            },
            eventDrop: function (info) {
                fetch(`/api/events/${info.event.id}`, {
                    method: 'PUT',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start: info.event.startStr,
                        end: info.event.endStr
                    })
                });
            },
            eventResize: function (info) {
                fetch(`/api/events/${info.event.id}`, {
                    method: 'PUT',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start: info.event.startStr,
                        end: info.event.endStr
                    })
                });
            }
        });
        calendar.render();

        document.getElementById('eventForm').addEventListener('submit', submitEvent);

        // 開始日を変更したら終了日も同じ値をデフォルトセット
        document.getElementById('eventStartDate').addEventListener('change', function () {
            const endDate = document.getElementById('eventEndDate');
            if (!endDate.value) {
                endDate.value = this.value;
            }
        });
    });

    // 日付 + 時間を ISO 文字列に結合するヘルパー
    function buildDatetime(dateVal, timeVal) {
        if (!dateVal) return '';
        if (timeVal) return dateVal + 'T' + timeVal;
        return dateVal;  // 日付のみ（終日イベント）
    }

    function openEventModal(event, startStr, endStr) {
        const modal = document.getElementById('eventModal');
        const title = document.getElementById('modalTitle');
        const submitBtn = document.getElementById('eventSubmitBtn');
        const deleteBtn = document.getElementById('eventDeleteBtn');

        if (event && event.id) {
            // 編集モード
            currentEventId = event.id;
            title.textContent = 'イベントを編集';
            submitBtn.textContent = '更新';
            deleteBtn.style.display = 'inline-flex';
            document.getElementById('eventTitleInput').value = event.title;
            document.getElementById('eventType').value = event.extendedProps.event_type || 'その他';
            document.getElementById('eventLocation').value = event.extendedProps.location_or_url || '';

            // 日付・時間を分割してセット
            const startFull = event.startStr || '';
            if (startFull.includes('T')) {
                document.getElementById('eventStartDate').value = startFull.slice(0, 10);
                document.getElementById('eventStartTime').value = startFull.slice(11, 16);
            } else {
                document.getElementById('eventStartDate').value = startFull.slice(0, 10);
                document.getElementById('eventStartTime').value = '';
            }

            const endFull = event.endStr || '';
            if (endFull.includes('T')) {
                document.getElementById('eventEndDate').value = endFull.slice(0, 10);
                document.getElementById('eventEndTime').value = endFull.slice(11, 16);
            } else {
                document.getElementById('eventEndDate').value = endFull.slice(0, 10);
                document.getElementById('eventEndTime').value = '';
            }
        } else {
            // 新規モード
            currentEventId = null;
            title.textContent = 'イベントを追加';
            submitBtn.textContent = '追加';
            deleteBtn.style.display = 'none';
            document.getElementById('eventForm').reset();
            if (startStr) {
                document.getElementById('eventStartDate').value = startStr.slice(0, 10);
                if (startStr.includes('T')) {
                    document.getElementById('eventStartTime').value = startStr.slice(11, 16);
                }
            }
            if (endStr) {
                document.getElementById('eventEndDate').value = endStr.slice(0, 10);
                if (endStr.includes('T')) {
                    document.getElementById('eventEndTime').value = endStr.slice(11, 16);
                }
            }
        }

        modal.style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('eventModal').style.display = 'none';
        currentEventId = null;
    }

    function submitEvent(e) {
        e.preventDefault();
        const startVal = buildDatetime(
            document.getElementById('eventStartDate').value,
            document.getElementById('eventStartTime').value
        );
        const endVal = buildDatetime(
            document.getElementById('eventEndDate').value,
            document.getElementById('eventEndTime').value
        );
        const data = {
            title: document.getElementById('eventTitleInput').value,
            event_type: document.getElementById('eventType').value,
            company_id: null,
            start: startVal,
            end: endVal,
            location_or_url: document.getElementById('eventLocation').value
        };

        if (currentEventId) {
            fetch(`/api/events/${currentEventId}`, {
                method: 'PUT',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(() => {
                calendar.refetchEvents();
                closeModal();
            });
        } else {
            fetch('/api/events', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(() => {
                calendar.refetchEvents();
                closeModal();
            });
        }
    }

    function deleteEvent() {
        if (!currentEventId) return;
        if (!confirm('このイベントを削除しますか？')) return;
        fetch(`/api/events/${currentEventId}`, { method: 'DELETE', credentials: 'same-origin' })
            .then(() => {
                calendar.refetchEvents();
                closeModal();
            });
    }
</script>
{% endblock %}